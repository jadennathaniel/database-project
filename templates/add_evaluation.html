<!DOCTYPE html>
<html lang="en">
<head>
    <title>Add Evaluation</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
    <meta charset="UTF-8" />
</head>
<body>
    <div class="nav">
        <a href="{{ url_for('index') }}">‚Üê Back to Home</a>
    </div>

    <h1>Add Evaluation</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- 
        Single form that:
        1. Requests Semester, Year, Instructor ID
        2. Requests Course, Section, and Goal
        3. Shows evaluation fields once all above are selected
    -->
    <form method="POST" action="{{ url_for('add_evaluation_route') }}" class="filter-form">
        <!-- Semester -->
        <div class="form-group">
            <label for="semester">Semester:</label>
            <select name="semester" id="semester" required>
                <option value="">Select Semester</option>
                <option value="Spring">Spring</option>
                <option value="Summer">Summer</option>
                <option value="Fall">Fall</option>
            </select>
        </div>

        <!-- Year -->
        <div class="form-group">
            <label for="year">Year:</label>
            <input type="number" 
                   id="year" 
                   name="year"
                   min="2000"
                   max="2099"
                   value="2024"
                   required>
        </div>

        <!-- Instructor ID -->
        <div class="form-group">
            <label for="instructor_id">Instructor ID:</label>
            <input type="text" 
                   id="instructor_id" 
                   name="instructor_id"
                   pattern="[0-9]{8}"
                   title="Enter 8-digit Instructor ID"
                   required>
        </div>

        <!-- Course Dropdown -->
        <div class="form-group">
            <label for="course_id">Course:</label>
            <select name="course_id" id="course_id" required>
                <option value="">Select a Course</option>
                {% for course in courses %}
                <option value="{{ course.course_id }}">{{ course.course_number }} - {{ course.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Section Dropdown -->
        <div class="form-group">
            <label for="section_id">Section:</label>
            <select name="section_id" id="section_id" required>
                <option value="">Select a Section</option>
                {% for section in sections %}
                <option value="{{ section.section_id }}"
                        data-course-id="{{ section.course_id }}"
                        data-instructor-id="{{ section.instructor_id }}"
                        data-semester="{{ section.semester }}"
                        data-year="{{ section.year }}">
                    {{ section.course_number }} - Section {{ section.section_number }} ({{ section.semester }} {{ section.year }})
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Goal Dropdown -->
        <div class="form-group">
            <label for="goal_id">Goal:</label>
            <select name="goal_id" id="goal_id" required>
                <option value="">Select a Goal</option>
                {% for goal in goals %}
                <option value="{{ goal.goal_id }}"
                        data-course-id="{{ goal.course_id|default(0) }}">
                    {{ goal.code }} - {{ goal.description }} ({{ goal.degree_name }} - {{ goal.degree_level }})
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Evaluation Fields (hidden until a goal is selected) -->
        <div id="evaluation-fields" style="display:none;">
            <h2>Evaluation Details</h2>
            
            <div class="form-group">
                <label for="evaluation_method">Evaluation Method:</label>
                <select name="evaluation_method" id="evaluation_method" required>
                    <option value="">Select Method</option>
                    {% set methods = ['Homework', 'Project', 'Quiz', 'Oral Presentation', 'Report', 'Mid-term', 'Final Exam', 'Other'] %}
                    {% for method in methods %}
                    <option value="{{ method }}">{{ method }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="grades-grid">
                <div class="form-group">
                    <label for="num_a">Grade A:</label>
                    <input type="number" id="num_a" name="num_a" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="num_b">Grade B:</label>
                    <input type="number" id="num_b" name="num_b" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="num_c">Grade C:</label>
                    <input type="number" id="num_c" name="num_c" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="num_f">Grade F:</label>
                    <input type="number" id="num_f" name="num_f" min="0" value="0">
                </div>
            </div>

            <div class="form-group">
                <label for="improvement">Suggested Improvements:</label>
                <textarea id="improvement" name="improvement" rows="4" placeholder="Optional"></textarea>
            </div>

            <div class="form-group">
                <label>Duplicate this evaluation to:</label>
                <div class="checkbox-grid">
                    {% for degree in other_degrees %}
                    <div class="checkbox-wrapper">
                        <input type="checkbox" name="duplicate_to_degrees" value="{{ degree.degree_id }}" id="dup_{{ degree.degree_id }}">
                        <label for="dup_{{ degree.degree_id }}">{{ degree.name }} ({{ degree.level }})</label>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="button-group">
                <button type="submit" class="button submit">Complete Evaluation</button>
            </div>
        </div>
    </form>

    <script>
        const semesterEl = document.getElementById('semester');
        const yearEl = document.getElementById('year');
        const instructorIdEl = document.getElementById('instructor_id');
        const courseEl = document.getElementById('course_id');
        const sectionEl = document.getElementById('section_id');
        const goalEl = document.getElementById('goal_id');
        const evaluationFields = document.getElementById('evaluation-fields');

        // Initially hide evaluation fields
        evaluationFields.style.display = 'none';

        // Show evaluation fields once all filters are chosen
        function checkIfReady() {
            if (semesterEl.value && yearEl.value && instructorIdEl.value &&
                courseEl.value && sectionEl.value && goalEl.value) {
                evaluationFields.style.display = 'block';
            } else {
                evaluationFields.style.display = 'none';
            }
        }

        // Attach event listeners to check readiness whenever a field changes
        [semesterEl, yearEl, instructorIdEl, courseEl, sectionEl, goalEl].forEach(el => {
            el.addEventListener('change', checkIfReady);
            el.addEventListener('input', checkIfReady);
        });
    </script>
</body>
</html>
